# Sharp edges for commit
#
# NOTE: The `detect` field is informational only - shows how to manually
# check for the edge case. Not automatically enforced.

edges:
  - id: amend-after-hook-failure
    description: "Using git commit --amend after pre-commit hook fails"
    detect: "Check if last commit succeeded or if hook failed"
    impact: "Amend modifies the PREVIOUS commit, not the failed one. May destroy work."
    fix: |
      - NEVER use --amend after hook failure
      - Fix the issue (lint, test, etc.)
      - Re-stage files if needed
      - Create a NEW commit
    severity: critical

  - id: staging-secrets
    description: "Accidentally staging .env, credentials, or API keys"
    detect: "git status | grep -E '\\.env|credentials|secret|key'"
    impact: "Secrets pushed to repo, security breach, credential rotation required."
    fix: |
      - Review git status before staging
      - Use git add <specific-files> instead of git add -A
      - Add sensitive files to .gitignore
      - If committed: rotate credentials immediately
    severity: critical

  - id: vague-commit-message
    description: "Using vague words like 'improve', 'enhance', 'update' in title"
    detect: "Check if title contains actionable, specific description"
    impact: "Git log becomes useless. Can't understand what changed."
    fix: |
      - Describe the specific change
      - Answer: what does this commit ADD/REMOVE/CHANGE?
      - Bad: "improve performance" -> Good: "cache docker layers in provisioning"
    severity: high

  - id: ai-attribution-in-commit
    description: "Including ANY AI attribution in commit message"
    detect: "Check for Co-Authored-By, AI, Claude, GPT, Copilot, 'Generated by', 'Created with'"
    impact: "Violates strict project rule. Commit will need to be amended or reset."
    fix: |
      Remove ALL AI attribution. This includes:
      - Co-Authored-By: Claude, GPT, or any AI name
      - Any AI-related emojis
      - "Generated by", "Created with", or similar phrases
      - Any reference to AI tools (Claude, ChatGPT, Copilot, etc.)

      If already committed:
      - git commit --amend (if not pushed)
      - Or git reset --soft HEAD~1 to redo the commit
    severity: critical

  - id: title-too-long
    description: "Commit title exceeds 50 characters"
    detect: "Count characters in first line of commit message"
    impact: "Git log, GitHub UI truncate long titles. Information lost."
    fix: |
      - Keep subject line <=50 characters
      - Move details to body
      - Be concise: use specific verbs, omit articles
    severity: medium

  - id: commit-to-main
    description: "Committing directly to main/master branch"
    detect: |
      BRANCH=$(git branch --show-current)
      if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
        echo "ERROR: On protected branch"
      fi
    impact: "Bypasses code review. May break CI. Violates workflow."
    fix: |
      - ALWAYS check branch before committing
      - Create a feature branch: git checkout -b <branch-name>
      - Use /workflow start for proper branch setup
    severity: critical

  - id: force-push-main
    description: "Force pushing to main/master branch"
    detect: "git log to check if HEAD was reset"
    impact: "Destroys shared history. Team loses work. Recovery complex."
    fix: |
      - NEVER force push to main/master
      - Use regular push or create a new branch
      - If needed, discuss with team first
    severity: critical

  - id: skip-hooks-without-permission
    description: "Using --no-verify without explicit user request"
    detect: "Check command for --no-verify flag"
    impact: "Skips pre-commit checks. May commit broken code."
    fix: |
      - Only use --no-verify if user explicitly requests
      - Fix hook failures instead of bypassing
    severity: high

  - id: ticket-refs-in-commit
    description: "Including ticket references in commit body"
    detect: "grep -E 'Fixes #|Closes #|Part of [A-Z]+-[0-9]+'"
    impact: "Violates project rule. Ticket refs belong in PR description."
    fix: |
      - Remove all ticket references from commit message
      - Add ticket references to PR description instead
    severity: medium

  - id: destructive-git-without-request
    description: "Running git reset --hard, checkout ., or clean -f unprompted"
    detect: "Check for destructive git commands in execution"
    impact: "Permanent data loss. User loses uncommitted work."
    fix: |
      - NEVER run destructive commands without explicit user request
      - Always warn user before any destructive action
      - Prefer non-destructive alternatives (stash, new branch)
    severity: critical

  - id: adding-extra-sections
    description: "Adding structured sections like 'Changes:', 'Files:', bullet lists to commit body"
    detect: "Check if commit body contains headers, colons, or bullet points"
    impact: "Violates commit format. Body should be 1-2 plain sentences, not structured."
    fix: |
      - Commit body is 1-2 sentences max, or omit entirely
      - NO "Changes:", "Files:", "Summary:", or similar headers
      - NO bullet lists or markdown formatting
      - Just plain sentences explaining WHY, not listing WHAT
    severity: medium
